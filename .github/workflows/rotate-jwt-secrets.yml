name: Rotate JWT Secrets Daily

on:
  schedule:
    - cron: '0 16 * * *'  # Runs daily at midnight SGT (UTC+8)
  workflow_dispatch:    # Allows manual trigger

jobs:
  rotate-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Generate new JWT secret key
        id: generate_key
        run: |
          echo "new_key=$(openssl rand -hex 32)" >> $GITHUB_OUTPUT

      - name: Update JWT_PREVIOUS_SECRET
        uses: peter-evans/create-or-update-secret@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          secret-name: JWT_PREVIOUS_SECRET
          secret-value: ${{ secrets.JWT_CURRENT_SECRET }}

      - name: Update JWT_CURRENT_SECRET
        uses: peter-evans/create-or-update-secret@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          secret-name: JWT_CURRENT_SECRET
          secret-value: ${{ steps.generate_key.outputs.new_key }}
